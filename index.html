<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ‹å°è¨­å‚™ç›¤é»ç³»çµ±</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#25272F">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
</head>
<body>
  <div class="header">
    <h1>ğŸ“š åœ‹å°è¨­å‚™ç›¤é»ç³»çµ±</h1>
    <div class="header-buttons">
      <button id="upload-btn" class="btn btn-success">ğŸ“¤ ä¸Šå‚³æ¸…å–®</button>
      <button id="qr-scan-btn" class="btn btn-success">ğŸ“± æƒç¢¼ç›¤é»</button>
      <button id="theme-toggle" class="btn btn-theme">ğŸ¨ åˆ‡æ›ä¸»é¡Œ</button>
    </div>
  </div>
  
  <div class="main-content">
    <div class="sidebar">
      <h2>ğŸ“‹ æ•™å®¤ç¯©é¸</h2>
      <input type="text" id="classroom-search" placeholder="ğŸ” æœå°‹æ•™å®¤...">
      <ul id="classroom-list"></ul>
      
      <div class="sidebar-actions">
        <button id="export-btn" class="btn btn-primary">ğŸ“Š åŒ¯å‡ºå ±è¡¨</button>
        <button id="reset-btn" class="btn btn-danger">ğŸ”„ é‡ç½®ç‹€æ…‹</button>
        <button id="bulk-check" class="btn btn-warning">âœ… æ‰¹é‡ç›¤é»</button>
      </div>
      
      <div class="progress-ring">
        <svg class="progress-ring-svg" width="120" height="120">
          <circle class="progress-ring-bg" cx="60" cy="60" r="50"></circle>
          <circle class="progress-ring-fill" cx="60" cy="60" r="50"></circle>
        </svg>
        <div class="progress-text">
          <span id="progress-percent">0%</span>
          <small>å®Œæˆç‡</small>
        </div>
      </div>
    </div>
    
    <div class="content">
      <!-- QR æ¸¬è©¦å€åŸŸ -->
      <div class="qr-test-section">
        <h3>ğŸ§ª QR Code æ¸¬è©¦å€</h3>
        <p>é»æ“Šä¸‹æ–¹ QR Code ä¾†æ¸¬è©¦ç›¤é»åŠŸèƒ½ï¼Œæˆ–ä½¿ç”¨æƒæå™¨æƒæï¼š</p>
        <div class="qr-grid" id="qr-test-grid">
          <!-- QR codes will be generated here -->
        </div>
      </div>
      
      <div class="toolbar">
        <div class="search-bar">
          <input type="text" id="search-input" placeholder="ğŸ” æœå°‹è¨­å‚™ç·¨è™Ÿã€åç¨±ã€æ•™å®¤...">
          <button id="clear-search" class="clear-btn">âœ•</button>
        </div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
          <button class="filter-btn" data-filter="unchecked">æœªç›¤é»</button>
          <button class="filter-btn" data-filter="checked">å·²ç›¤é»</button>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“¦</div>
          <div class="stat-info">
            <div class="stat-number" id="total-count">0</div>
            <div class="stat-label">ç¸½è¨­å‚™æ•¸</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-info">
            <div class="stat-number" id="checked-count">0</div>
            <div class="stat-label">å·²ç›¤é»</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â³</div>
          <div class="stat-info">
            <div class="stat-number" id="unchecked-count">0</div>
            <div class="stat-label">æœªç›¤é»</div>
          </div>
        </div>
      </div>
      
      <div class="table-container">
        <table id="equipment-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>ç·¨è™Ÿ</th>
              <th>åç¨±</th>
              <th>æ•™å®¤</th>
              <th>ç‹€æ…‹</th>
              <th>æœ€å¾Œæ›´æ–°</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- æª”æ¡ˆä¸Šå‚³å€åŸŸ -->
  <div class="upload-overlay" id="upload-overlay">
    <div class="upload-content">
      <div class="upload-icon">ğŸ“„</div>
      <h3>æ‹–æ”¾ CSV æª”æ¡ˆåˆ°æ­¤è™•</h3>
      <p>æˆ–è€…</p>
      <input type="file" id="file-input" accept=".csv" style="display: none;">
      <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">é¸æ“‡æª”æ¡ˆ</button>
      <button class="btn btn-secondary" onclick="closeUpload()">å–æ¶ˆ</button>
      <div class="file-format-help">
        <p><strong>CSV æ ¼å¼è¦æ±‚ï¼š</strong></p>
        <code>ç·¨è™Ÿ,åç¨±,æ•™å®¤<br>EQ001,æŠ•å½±æ©Ÿ,101æ•™å®¤<br>EQ002,é›»è…¦,102æ•™å®¤</code>
      </div>
    </div>
  </div>
  
  <!-- QR æƒæå™¨ -->
  <div class="qr-scanner" id="qr-scanner">
    <button class="close-scanner" onclick="closeQRScanner()">Ã—</button>
    <div class="qr-scanner-content">
      <h3>ğŸ“± QR Code æƒæå™¨</h3>
      <div class="camera-container">
        <video id="qr-video" playsinline></video>
        <div class="scan-overlay">
          <div class="scan-frame"></div>
        </div>
      </div>
      <p id="scan-status">è«‹å°‡ QR Code å°æº–æƒææ¡†</p>
      <div class="scanner-buttons">
        <button id="switch-camera" class="btn btn-secondary">ğŸ”„ åˆ‡æ›é¡é ­</button>
        <button onclick="closeQRScanner()" class="btn btn-primary">é—œé–‰æƒæå™¨</button>
      </div>
    </div>
  </div>

  <!-- è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ -->
  <div class="loading" id="loading" style="display: none;">
    <div class="spinner"></div>
    <p>è™•ç†ä¸­...</p>
  </div>

  <!-- Toast é€šçŸ¥å®¹å™¨ -->
  <div id="toast-container"></div>

  <!-- å¼•å…¥å¿…è¦çš„ JavaScript åº« -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  
  <!-- QR Code ç”Ÿæˆå™¨ -->
  <script>
    // QR Code ç”Ÿæˆå’Œæ¸¬è©¦åŠŸèƒ½
    class QRTestManager {
      constructor() {
        this.testEquipment = [
          { ç·¨è™Ÿ: '314010102-300933', åç¨±: 'ASUS WS690T å·¥ä½œç«™ä¸»æ©Ÿ', æ•™å®¤: 'å¤§åŒæ¨“1æ¨“ç§‘ä»»è¾¦å…¬å®¤D108' },
          { ç·¨è™Ÿ: '314010102-301601', åç¨±: 'ASUS WS750T', æ•™å®¤: 'å¤§åŒæ¨“2æ¨“é›»è…¦æ•™å®¤D216' },
          { ç·¨è™Ÿ: '314010103-300207', åç¨±: 'Acer Veritpon M480', æ•™å®¤: 'å‹¤å­¸æ¨“3æ¨“è³‡è¨Šè¨­å‚™å®¤A303' },
          { ç·¨è™Ÿ: 'EQ001', åç¨±: 'æŠ•å½±æ©Ÿ', æ•™å®¤: '101æ•™å®¤' },
          { ç·¨è™Ÿ: 'EQ002', åç¨±: 'é›»è…¦', æ•™å®¤: '101æ•™å®¤' },
          { ç·¨è™Ÿ: 'EQ003', åç¨±: 'éŸ³éŸ¿', æ•™å®¤: '102æ•™å®¤' }
        ];
        
        this.init();
      }
      
      init() {
        // ç­‰å¾… QRious åº«è¼‰å…¥
        setTimeout(() => {
          this.generateTestQRCodes();
        }, 1000);
      }
      
      generateQRCode(data, size = 120) {
        try {
          if (typeof QRious !== 'undefined') {
            const qr = new QRious({
              value: data,
              size: size,
              background: 'white',
              foreground: 'black',
              level: 'M'
            });
            return qr.toDataURL();
          } else {
            console.warn('QRious åº«æœªè¼‰å…¥ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ');
            return this.generateFallbackQR(data);
          }
        } catch (error) {
          console.error('ç”Ÿæˆ QR Code å¤±æ•—:', error);
          return this.generateFallbackQR(data);
        }
      }
      
      generateFallbackQR(data) {
        // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç·šä¸Š QR ç”Ÿæˆæœå‹™
        return `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(data)}`;
      }
      
      generateTestQRCodes() {
        const grid = document.getElementById('qr-test-grid');
        if (!grid) return;

        grid.innerHTML = '';
        
        this.testEquipment.forEach(item => {
          const qrDataURL = this.generateQRCode(item.ç·¨è™Ÿ, 120);
          
          const qrItem = document.createElement('div');
          qrItem.className = 'qr-item';
          qrItem.innerHTML = `
            <img src="${qrDataURL}" 
                 alt="QR Code for ${item.ç·¨è™Ÿ}" 
                 class="qr-code" 
                 onclick="testQRScan('${item.ç·¨è™Ÿ}')"
                 style="cursor: pointer; border: 2px solid #ddd; border-radius: 8px;">
            <div class="qr-label">${item.åç¨±}</div>
            <div class="qr-id">${item.ç·¨è™Ÿ}</div>
            <small style="color: #666; font-size: 0.75rem;">é»æ“Šæ¸¬è©¦æƒæ</small>
          `;
          
          grid.appendChild(qrItem);
        });
        
        console.log('âœ… å·²ç”Ÿæˆ', this.testEquipment.length, 'å€‹æ¸¬è©¦ QR Code');
      }
    }
    
    // æ¸¬è©¦ QR æƒæå‡½æ•¸
    function testQRScan(equipmentId) {
      console.log('ğŸ§ª æ¸¬è©¦ QR æƒæ:', equipmentId);
      
      // æ¨¡æ“¬æƒææ•ˆæœ
      const event = new CustomEvent('qrScanned', {
        detail: { 
          data: equipmentId,
          timestamp: new Date().toISOString(),
          source: 'test'
        }
      });
      
      // è§¸ç™¼æƒæäº‹ä»¶
      if (window.inventory && typeof window.inventory.handleQRScan === 'function') {
        window.inventory.handleQRScan(equipmentId);
      } else {
        document.dispatchEvent(event);
      }
      
      // è¦–è¦ºåé¥‹
      const clickedElement = event.target || document.querySelector(`[onclick="testQRScan('${equipmentId}')"]`);
      if (clickedElement) {
        clickedElement.style.transform = 'scale(0.95)';
        clickedElement.style.transition = 'transform 0.1s';
        setTimeout(() => {
          clickedElement.style.transform = '';
        }, 100);
      }
    }
    
    // åˆå§‹åŒ–æ¸¬è©¦ç®¡ç†å™¨
    document.addEventListener('DOMContentLoaded', () => {
      window.qrTestManager = new QRTestManager();
    });
  </script>
  
  <!-- å¼•å…¥è‡ªå®šç¾© JavaScript -->
  <script src="js/qr-scanner.js"></script>
  <script src="js/main.js"></script>

  <!-- æ–°å¢ CSS æ¨£å¼ -->
  <style>
    /* QR æ¸¬è©¦å€åŸŸæ¨£å¼ */
    .qr-test-section {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 4px solid #17a2b8;
    }

    .qr-test-section h3 {
      color: #17a2b8;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .qr-item {
      text-align: center;
      padding: 1rem;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    .qr-item:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transform: translateY(-2px);
      background: white;
    }

    .qr-code {
      width: 120px;
      height: 120px;
      margin: 0 auto 0.5rem;
      display: block;
    }

    .qr-label {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .qr-id {
      font-weight: bold;
      color: #007bff;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    /* éŸ¿æ‡‰å¼èª¿æ•´ */
    @media (max-width: 768px) {
      .qr-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
      }
      
      .qr-code {
        width: 100px;
        height: 100px;
      }
      
      .qr-item {
        padding: 0.75rem;
      }
    }
  </style>
</body>
</html>
