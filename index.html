<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>國小設備盤點系統</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#25272F">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📚</text></svg>">
</head>
<body>
  <div class="header">
    <h1>📚 國小設備盤點系統</h1>
    <div class="header-buttons">
      <button id="upload-btn" class="btn btn-success">📤 上傳清單</button>
      <button id="qr-scan-btn" class="btn btn-success">📱 掃碼盤點</button>
      <button id="theme-toggle" class="btn btn-theme">🎨 切換主題</button>
    </div>
  </div>
  
  <div class="main-content">
    <div class="sidebar">
      <h2>📋 教室篩選</h2>
      <input type="text" id="classroom-search" placeholder="🔍 搜尋教室...">
      <ul id="classroom-list"></ul>
      
      <div class="sidebar-actions">
        <button id="export-btn" class="btn btn-primary">📊 匯出報表</button>
        <button id="reset-btn" class="btn btn-danger">🔄 重置狀態</button>
        <button id="bulk-check" class="btn btn-warning">✅ 批量盤點</button>
      </div>
      
      <div class="progress-ring">
        <svg class="progress-ring-svg" width="120" height="120">
          <circle class="progress-ring-bg" cx="60" cy="60" r="50"></circle>
          <circle class="progress-ring-fill" cx="60" cy="60" r="50"></circle>
        </svg>
        <div class="progress-text">
          <span id="progress-percent">0%</span>
          <small>完成率</small>
        </div>
      </div>
    </div>
    
    <div class="content">
      <!-- QR 測試區域 -->
      <div class="qr-test-section">
        <h3>🧪 QR Code 測試區</h3>
        <p>點擊下方 QR Code 來測試盤點功能，或使用掃描器掃描：</p>
        <div class="qr-grid" id="qr-test-grid">
          <!-- QR codes will be generated here -->
        </div>
      </div>
      
      <div class="toolbar">
        <div class="search-bar">
          <input type="text" id="search-input" placeholder="🔍 搜尋設備編號、名稱、教室...">
          <button id="clear-search" class="clear-btn">✕</button>
        </div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">全部</button>
          <button class="filter-btn" data-filter="unchecked">未盤點</button>
          <button class="filter-btn" data-filter="checked">已盤點</button>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <div class="stat-icon">📦</div>
          <div class="stat-info">
            <div class="stat-number" id="total-count">0</div>
            <div class="stat-label">總設備數</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">✅</div>
          <div class="stat-info">
            <div class="stat-number" id="checked-count">0</div>
            <div class="stat-label">已盤點</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">⏳</div>
          <div class="stat-info">
            <div class="stat-number" id="unchecked-count">0</div>
            <div class="stat-label">未盤點</div>
          </div>
        </div>
      </div>
      
      <div class="table-container">
        <table id="equipment-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>編號</th>
              <th>名稱</th>
              <th>教室</th>
              <th>狀態</th>
              <th>最後更新</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- 檔案上傳區域 -->
  <div class="upload-overlay" id="upload-overlay">
    <div class="upload-content">
      <div class="upload-icon">📄</div>
      <h3>拖放 CSV 檔案到此處</h3>
      <p>或者</p>
      <input type="file" id="file-input" accept=".csv" style="display: none;">
      <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">選擇檔案</button>
      <button class="btn btn-secondary" onclick="closeUpload()">取消</button>
      <div class="file-format-help">
        <p><strong>CSV 格式要求：</strong></p>
        <code>編號,名稱,教室<br>EQ001,投影機,101教室<br>EQ002,電腦,102教室</code>
      </div>
    </div>
  </div>
  
  <!-- QR 掃描器 -->
  <div class="qr-scanner" id="qr-scanner">
    <button class="close-scanner" onclick="closeQRScanner()">×</button>
    <div class="qr-scanner-content">
      <h3>📱 QR Code 掃描器</h3>
      <div class="camera-container">
        <video id="qr-video" playsinline></video>
        <div class="scan-overlay">
          <div class="scan-frame"></div>
        </div>
      </div>
      <p id="scan-status">請將 QR Code 對準掃描框</p>
      <div class="scanner-buttons">
        <button id="switch-camera" class="btn btn-secondary">🔄 切換鏡頭</button>
        <button onclick="closeQRScanner()" class="btn btn-primary">關閉掃描器</button>
      </div>
    </div>
  </div>

  <!-- 載入中指示器 -->
  <div class="loading" id="loading" style="display: none;">
    <div class="spinner"></div>
    <p>處理中...</p>
  </div>

  <!-- Toast 通知容器 -->
  <div id="toast-container"></div>

  <!-- 引入必要的 JavaScript 庫 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  
  <!-- QR Code 生成器 -->
  <script>
    // QR Code 生成和測試功能
    class QRTestManager {
      constructor() {
        this.testEquipment = [
          { 編號: '314010102-300933', 名稱: 'ASUS WS690T 工作站主機', 教室: '大同樓1樓科任辦公室D108' },
          { 編號: '314010102-301601', 名稱: 'ASUS WS750T', 教室: '大同樓2樓電腦教室D216' },
          { 編號: '314010103-300207', 名稱: 'Acer Veritpon M480', 教室: '勤學樓3樓資訊設備室A303' },
          { 編號: 'EQ001', 名稱: '投影機', 教室: '101教室' },
          { 編號: 'EQ002', 名稱: '電腦', 教室: '101教室' },
          { 編號: 'EQ003', 名稱: '音響', 教室: '102教室' }
        ];
        
        this.init();
      }
      
      init() {
        // 等待 QRious 庫載入
        setTimeout(() => {
          this.generateTestQRCodes();
        }, 1000);
      }
      
      generateQRCode(data, size = 120) {
        try {
          if (typeof QRious !== 'undefined') {
            const qr = new QRious({
              value: data,
              size: size,
              background: 'white',
              foreground: 'black',
              level: 'M'
            });
            return qr.toDataURL();
          } else {
            console.warn('QRious 庫未載入，使用備用方案');
            return this.generateFallbackQR(data);
          }
        } catch (error) {
          console.error('生成 QR Code 失敗:', error);
          return this.generateFallbackQR(data);
        }
      }
      
      generateFallbackQR(data) {
        // 備用方案：使用線上 QR 生成服務
        return `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(data)}`;
      }
      
      generateTestQRCodes() {
        const grid = document.getElementById('qr-test-grid');
        if (!grid) return;

        grid.innerHTML = '';
        
        this.testEquipment.forEach(item => {
          const qrDataURL = this.generateQRCode(item.編號, 120);
          
          const qrItem = document.createElement('div');
          qrItem.className = 'qr-item';
          qrItem.innerHTML = `
            <img src="${qrDataURL}" 
                 alt="QR Code for ${item.編號}" 
                 class="qr-code" 
                 onclick="testQRScan('${item.編號}')"
                 style="cursor: pointer; border: 2px solid #ddd; border-radius: 8px;">
            <div class="qr-label">${item.名稱}</div>
            <div class="qr-id">${item.編號}</div>
            <small style="color: #666; font-size: 0.75rem;">點擊測試掃描</small>
          `;
          
          grid.appendChild(qrItem);
        });
        
        console.log('✅ 已生成', this.testEquipment.length, '個測試 QR Code');
      }
    }
    
    // 測試 QR 掃描函數
    function testQRScan(equipmentId) {
      console.log('🧪 測試 QR 掃描:', equipmentId);
      
      // 模擬掃描效果
      const event = new CustomEvent('qrScanned', {
        detail: { 
          data: equipmentId,
          timestamp: new Date().toISOString(),
          source: 'test'
        }
      });
      
      // 觸發掃描事件
      if (window.inventory && typeof window.inventory.handleQRScan === 'function') {
        window.inventory.handleQRScan(equipmentId);
      } else {
        document.dispatchEvent(event);
      }
      
      // 視覺反饋
      const clickedElement = event.target || document.querySelector(`[onclick="testQRScan('${equipmentId}')"]`);
      if (clickedElement) {
        clickedElement.style.transform = 'scale(0.95)';
        clickedElement.style.transition = 'transform 0.1s';
        setTimeout(() => {
          clickedElement.style.transform = '';
        }, 100);
      }
    }
    
    // 初始化測試管理器
    document.addEventListener('DOMContentLoaded', () => {
      window.qrTestManager = new QRTestManager();
    });
  </script>
  
  <!-- 引入自定義 JavaScript -->
  <script src="js/qr-scanner.js"></script>
  <script src="js/main.js"></script>

  <!-- 新增 CSS 樣式 -->
  <style>
    /* QR 測試區域樣式 */
    .qr-test-section {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 4px solid #17a2b8;
    }

    .qr-test-section h3 {
      color: #17a2b8;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .qr-item {
      text-align: center;
      padding: 1rem;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    .qr-item:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transform: translateY(-2px);
      background: white;
    }

    .qr-code {
      width: 120px;
      height: 120px;
      margin: 0 auto 0.5rem;
      display: block;
    }

    .qr-label {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .qr-id {
      font-weight: bold;
      color: #007bff;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    /* 響應式調整 */
    @media (max-width: 768px) {
      .qr-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
      }
      
      .qr-code {
        width: 100px;
        height: 100px;
      }
      
      .qr-item {
        padding: 0.75rem;
      }
    }
  </style>
</body>
</html>
