<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>國小設備盤點系統</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
      background: #181B22;
      color: #FFF;
      line-height: 1.6;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #25272F;
      padding: 15px 20px;
      border-bottom: 2px solid #23252C;
      flex-wrap: wrap;
    }
    
    h1 {
      font-size: 1.8rem;
      margin: 0;
      flex: 1;
      min-width: 200px;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .main-content {
      display: flex;
      min-height: calc(100vh - 80px);
      flex-direction: row;
    }
    
    .sidebar {
      width: 280px;
      background: #22232C;
      padding: 20px 15px;
      border-right: 2px solid #23252C;
      overflow-y: auto;
    }
    
    .sidebar h2 {
      margin-top: 0;
      font-size: 1.3rem;
    }
    
    .sidebar input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #35394D;
      background: #23263A;
      color: #fff;
      font-size: 1rem;
    }
    
    #classroom-list {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    #classroom-list li {
      margin-bottom: 8px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background 0.15s;
      font-size: 0.95rem;
    }
    
    #classroom-list li.selected,
    #classroom-list li:hover {
      background: #444556;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 1rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s;
      font-weight: bold;
    }
    
    .btn-primary {
      background: #555BE3;
      color: #fff;
    }
    
    .btn-primary:hover {
      background: #7D83F3;
    }
    
    .btn-success {
      background: #28a745;
      color: #fff;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn-theme {
      background: #4347AB;
      color: #fff;
      padding: 8px 16px;
      font-size: 0.9rem;
    }
    
    .btn-theme:hover {
      background: #585FFF;
    }
    
    .content {
      flex: 1;
      padding: 20px;
      overflow-x: auto;
    }
    
    .search-bar {
      margin-bottom: 20px;
    }
    
    #search-input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #35394D;
      background: #23263A;
      color: #fff;
      font-size: 1rem;
    }
    
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: #23263A;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      min-width: 120px;
      flex: 1;
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    #equipment-table {
      width: 100%;
      border-collapse: collapse;
      background: #23263A;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(24, 27, 34, 0.3);
    }
    
    #equipment-table th,
    #equipment-table td {
      padding: 12px 8px;
      text-align: center;
      font-size: 0.9rem;
    }
    
    #equipment-table th {
      background: #2a2d3a;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    #equipment-table tbody tr {
      transition: background 0.1s;
    }
    
    #equipment-table tbody tr:hover {
      background: #343C55;
    }
    
    .status-cell {
      font-weight: bold;
      border-radius: 6px;
      padding: 6px 12px;
      display: inline-block;
      cursor: pointer;
      user-select: none;
      min-width: 70px;
      font-size: 0.85rem;
    }
    
    .status-unchecked {
      background: #FFB26B;
      color: #31210C;
    }
    
    .status-checked {
      background: #77E6B6;
      color: #085D45;
    }
    
    .qr-scanner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .qr-scanner-content {
      background: #23263A;
      padding: 20px;
      border-radius: 15px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    #qr-video {
      width: 100%;
      max-width: 300px;
      height: 300px;
      border-radius: 10px;
      margin: 10px 0;
    }
    
    .close-scanner {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ff4757;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
    }
    
    /* 響應式設計 */
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 2px solid #23252C;
        max-height: 300px;
      }
      
      .header {
        padding: 10px 15px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .header-buttons {
        width: 100%;
        justify-content: flex-end;
        margin-top: 10px;
      }
      
      .stats {
        gap: 10px;
      }
      
      .stat-card {
        min-width: 100px;
      }
      
      #equipment-table {
        font-size: 0.8rem;
      }
      
      #equipment-table th,
      #equipment-table td {
        padding: 8px 4px;
      }
      
      .status-cell {
        padding: 4px 8px;
        font-size: 0.75rem;
        min-width: 60px;
      }
    }
    
    @media (max-width: 480px) {
      .content {
        padding: 15px 10px;
      }
      
      .sidebar {
        padding: 15px 10px;
      }
      
      #equipment-table th:nth-child(3),
      #equipment-table td:nth-child(3) {
        display: none;
      }
    }
    
    /* 主題樣式 */
    .theme-high-contrast .status-unchecked {
      background: #FF4665;
      color: #fff;
    }
    
    .theme-high-contrast .status-checked {
      background: #1BE7FF;
      color: #16344E;
    }
    
    .theme-colorblind .status-unchecked {
      background: #FFD700;
      color: #634500;
    }
    
    .theme-colorblind .status-checked {
      background: #339933;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>國小設備盤點系統</h1>
    <div class="header-buttons">
      <button id="qr-scan-btn" class="btn btn-success">📱 掃碼盤點</button>
      <button id="theme-toggle" class="btn btn-theme">切換主題</button>
    </div>
  </div>
  
  <div class="main-content">
    <div class="sidebar">
      <h2>📋 教室篩選</h2>
      <input type="text" id="classroom-search" placeholder="🔍 搜尋教室...">
      <ul id="classroom-list"></ul>
      <button id="export-btn" class="btn btn-primary">📤 匯出報表</button>
      <button id="reset-btn" class="btn btn-primary">🔄 重置狀態</button>
    </div>
    
    <div class="content">
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="🔍 搜尋設備編號、名稱...">
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-count">0</div>
          <div class="stat-label">總設備數</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="checked-count">0</div>
          <div class="stat-label">已盤點</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="unchecked-count">0</div>
          <div class="stat-label">未盤點</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="progress-percent">0%</div>
          <div class="stat-label">完成率</div>
        </div>
      </div>
      
      <table id="equipment-table">
        <thead>
          <tr>
            <th>編號</th>
            <th>名稱</th>
            <th>教室</th>
            <th>狀態</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <!-- QR 掃描器 -->
  <div class="qr-scanner" id="qr-scanner">
    <button class="close-scanner" onclick="closeQRScanner()">×</button>
    <div class="qr-scanner-content">
      <h3>📱 QR Code 掃描器</h3>
      <video id="qr-video"></video>
      <p>請將 QR Code 對準鏡頭</p>
      <button onclick="closeQRScanner()" class="btn btn-primary">關閉掃描器</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
  <script>
    // 設備盤點系統主要功能
    let data = [];
    let classrooms = [];
    let currentClassroom = null;
    let theme = 'default';
    let qrScanner = null;

    // 模擬設備資料
    const mockData = [
      { 編號: 'EQ001', 名稱: '投影機', 教室: '101教室', 狀態: '未盤點' },
      { 編號: 'EQ002', 名稱: '電腦', 教室: '101教室', 狀態: '未盤點' },
      { 編號: 'EQ003', 名稱: '音響', 教室: '102教室', 狀態: '未盤點' },
      { 編號: 'EQ004', 名稱: '白板', 教室: '102教室', 狀態: '未盤點' },
      { 編號: 'EQ005', 名稱: '掃描器', 教室: '103教室', 狀態: '未盤點' },
      { 編號: 'EQ006', 名稱: '印表機', 教室: '103教室', 狀態: '未盤點' },
      { 編號: 'EQ007', 名稱: '攝影機', 教室: '音樂教室', 狀態: '未盤點' },
      { 編號: 'EQ008', 名稱: '鋼琴', 教室: '音樂教室', 狀態: '未盤點' },
      { 編號: 'EQ009', 名稱: '籃球', 教室: '體育器材室', 狀態: '未盤點' },
      { 編號: 'EQ010', 名稱: '排球', 教室: '體育器材室', 狀態: '未盤點' }
    ];

    // 狀態樣式映射
    const statusMap = {
      '未盤點': 'status-unchecked',
      '已盤點': 'status-checked'
    };

    // 初始化系統
    function initSystem() {
      // 載入或使用模擬資料
      data = mockData.slice();
      
      // 恢復已儲存的狀態
      restoreStatus();
      
      // 建立教室清單
      classrooms = Array.from(new Set(data.map(d => d.教室))).sort();
      
      // 渲染介面
      renderClassroomList();
      renderTable();
      updateStats();
      
      // 綁定事件
      bindEvents();
    }

    // 綁定事件監聽器
    function bindEvents() {
      document.getElementById('search-input').addEventListener('input', renderTable);
      document.getElementById('classroom-search').addEventListener('input', filterClassrooms);
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      document.getElementById('export-btn').addEventListener('click', exportData);
      document.getElementById('reset-btn').addEventListener('click', resetStatus);
      document.getElementById('qr-scan-btn').addEventListener('click', startQRScanner);
    }

    // 主題切換
    function toggleTheme() {
      if (theme === 'default') theme = 'high-contrast';
      else if (theme === 'high-contrast') theme = 'colorblind';
      else theme = 'default';
      
      applyTheme();
      renderTable();
    }

    function applyTheme() {
      document.body.classList.remove('theme-high-contrast', 'theme-colorblind');
      if (theme === 'high-contrast') document.body.classList.add('theme-high-contrast');
      if (theme === 'colorblind') document.body.classList.add('theme-colorblind');
    }

    // 渲染教室清單
    function renderClassroomList() {
      const list = document.getElementById('classroom-list');
      list.innerHTML = '';
      
      // 全部選項
      const allItem = document.createElement('li');
      allItem.textContent = '📚 全部教室';
      allItem.className = currentClassroom ? '' : 'selected';
      allItem.onclick = () => {
        currentClassroom = null;
        renderTable();
        renderClassroomList();
      };
      list.appendChild(allItem);
      
      // 各教室選項
      classrooms.forEach(cls => {
        const li = document.createElement('li');
        li.textContent = `🏫 ${cls}`;
        li.className = (currentClassroom === cls) ? 'selected' : '';
        li.onclick = () => {
          currentClassroom = cls;
          renderTable();
          renderClassroomList();
        };
        list.appendChild(li);
      });
    }

    // 過濾教室
    function filterClassrooms() {
      const keyword = document.getElementById('classroom-search').value.trim().toLowerCase();
      const items = document.querySelectorAll('#classroom-list li');
      
      items.forEach((item, index) => {
        if (index === 0) return; // 跳過"全部"選項
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(keyword) ? '' : 'none';
      });
    }

    // 渲染設備表格
    function renderTable() {
      const keyword = document.getElementById('search-input').value.trim().toLowerCase();
      const tbody = document.querySelector('#equipment-table tbody');
      tbody.innerHTML = '';
      
      let filteredData = data.filter(d => 
        (!currentClassroom || d.教室 === currentClassroom) &&
        (d.編號.toLowerCase().includes(keyword) || 
         d.名稱.toLowerCase().includes(keyword) ||
         d.教室.toLowerCase().includes(keyword))
      );
      
      filteredData.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${d.編號}</strong></td>
          <td>${d.名稱}</td>
          <td>${d.教室}</td>
          <td>
            <span class="status-cell ${statusMap[d.狀態] || 'status-unchecked'}" 
                  onclick="toggleStatus('${d.編號}')">${d.狀態}</span>
          </td>
          <td>
            <button onclick="toggleStatus('${d.編號}')" class="btn" style="padding: 5px 10px; font-size: 0.8rem;">
              ${d.狀態 === '未盤點' ? '✅ 盤點' : '❌ 取消'}
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      updateStats();
    }

    // 切換設備狀態
    function toggleStatus(equipmentId) {
      const item = data.find(d => d.編號 === equipmentId);
      if (item) {
        item.狀態 = item.狀態 === '未盤點' ? '已盤點' : '未盤點';
        saveStatus();
        renderTable();
        
        // 顯示提示
        showToast(`${item.編號} - ${item.名稱} 已${item.狀態}`);
      }
    }

    // 更新統計資訊
    function updateStats() {
      const filteredData = currentClassroom ? 
        data.filter(d => d.教室 === currentClassroom) : data;
      
      const total = filteredData.length;
      const checked = filteredData.filter(d => d.狀態 === '已盤點').length;
      const unchecked = total - checked;
      const progress = total > 0 ? Math.round((checked / total) * 100) : 0;
      
      document.getElementById('total-count').textContent = total;
      document.getElementById('checked-count').textContent = checked;
      document.getElementById('unchecked-count').textContent = unchecked;
      document.getElementById('progress-percent').textContent = `${progress}%`;
      
      // 更新進度顏色
      const progressElement = document.getElementById('progress-percent');
      if (progress === 100) {
        progressElement.style.color = '#77E6B6';
      } else if (progress >= 50) {
        progressElement.style.color = '#FFB26B';
      } else {
        progressElement.style.color = '#FF6B6B';
      }
    }

    // 儲存狀態
    function saveStatus() {
      const statusData = data.map(d => ({ 編號: d.編號, 狀態: d.狀態 }));
      // 在真實環境中會使用 localStorage
      console.log('儲存狀態:', statusData);
    }

    // 恢復狀態
    function restoreStatus() {
      // 在真實環境中會從 localStorage 讀取
      console.log('恢復狀態');
    }

    // 重置所有狀態
    function resetStatus() {
      if (confirm('確定要重置所有設備的盤點狀態嗎？')) {
        data.forEach(d => d.狀態 = '未盤點');
        saveStatus();
        renderTable();
        showToast('所有設備狀態已重置');
      }
    }

    // 匯出資料
    function exportData() {
      let csv = "編號,名稱,教室,狀態\n";
      data.forEach(d => {
        csv += `${d.編號},${d.名稱},${d.教室},${d.狀態}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `設備盤點報表_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('報表已匯出');
    }

    // QR Code 掃描功能
    function startQRScanner() {
      const scanner = document.getElementById('qr-scanner');
      const video = document.getElementById('qr-video');
      
      scanner.style.display = 'flex';
      
      // 檢查是否支援相機
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        })
        .then(stream => {
          video.srcObject = stream;
          video.play();
          
          // 使用 QR Scanner 程式庫
          if (typeof QrScanner !== 'undefined') {
            qrScanner = new QrScanner(video, result => {
              handleQRResult(result);
            });
            qrScanner.start();
          } else {
            // 簡化版：模擬 QR 掃描
            showToast('請點擊設備編號進行手動盤點');
          }
        })
        .catch(err => {
          console.error('無法開啟相機:', err);
          showToast('無法開啟相機，請檢查權限設定');
          closeQRScanner();
        });
      } else {
        showToast('您的瀏覽器不支援相機功能');
        closeQRScanner();
      }
    }

    function closeQRScanner() {
      const scanner = document.getElementById('qr-scanner');
      const video = document.getElementById('qr-video');
      
      scanner.style.display = 'none';
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      
      if (qrScanner) {
        qrScanner.stop();
        qrScanner = null;
      }
    }

    function handleQRResult(result) {
      const equipmentId = result.data || result;
      const item = data.find(d => d.編號 === equipmentId);
      
      if (item) {
        item.狀態 = '已盤點';
        saveStatus();
        renderTable();
        showToast(`✅ ${item.編號} - ${item.名稱} 盤點完成`);
      } else {
        showToast(`❌ 找不到設備編號: ${equipmentId}`);
      }
      
      closeQRScanner();
    }

    // 顯示提示訊息
    function showToast(message) {
      // 創建提示元素
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #23263A;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1001;
        font-weight: bold;
        max-width: 300px;
        word-wrap: break-word;
      `;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      // 3秒後自動移除
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 3000);
    }

    // 初始化系統
    document.addEventListener('DOMContentLoaded', initSystem);
    
    // 全域函數
    window.closeQRScanner = closeQRScanner;
    window.toggleStatus = toggleStatus;
  </script>
</body>
</html>
