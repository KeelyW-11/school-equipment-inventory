<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ‹å°è¨­å‚™ç›¤é»ç³»çµ±</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#25272F">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
</head>
<body>
  <div class="header">
    <h1>ğŸ“š åœ‹å°è¨­å‚™ç›¤é»ç³»çµ±</h1>
    <div class="header-buttons">
      <button id="upload-btn" class="btn btn-success">ğŸ“¤ ä¸Šå‚³æ¸…å–®</button>
      <button id="qr-scan-btn" class="btn btn-success">ğŸ“± æƒç¢¼ç›¤é»</button>
      <button id="theme-toggle" class="btn btn-theme">ğŸ¨ åˆ‡æ›ä¸»é¡Œ</button>
    </div>
  </div>
  
  <div class="main-content">
    <div class="sidebar">
      <h2>ğŸ“‹ æ•™å®¤ç¯©é¸</h2>
      <input type="text" id="classroom-search" placeholder="ğŸ” æœå°‹æ•™å®¤...">
      <ul id="classroom-list"></ul>
      
      <div class="sidebar-actions">
        <button id="export-btn" class="btn btn-primary">ğŸ“Š åŒ¯å‡ºå ±è¡¨</button>
        <button id="reset-btn" class="btn btn-danger">ğŸ”„ é‡ç½®ç‹€æ…‹</button>
        <button id="bulk-check" class="btn btn-warning">âœ… æ‰¹é‡ç›¤é»</button>
      </div>
      
      <div class="progress-ring">
        <svg class="progress-ring-svg" width="120" height="120">
          <circle class="progress-ring-bg" cx="60" cy="60" r="50"></circle>
          <circle class="progress-ring-fill" cx="60" cy="60" r="50"></circle>
        </svg>
        <div class="progress-text">
          <span id="progress-percent">0%</span>
          <small>å®Œæˆç‡</small>
        </div>
      </div>
    </div>
    
    <div class="content">
      <div class="toolbar">
        <div class="search-bar">
          <input type="text" id="search-input" placeholder="ğŸ” æœå°‹è¨­å‚™ç·¨è™Ÿã€åç¨±ã€æ•™å®¤...">
          <button id="clear-search" class="clear-btn">âœ•</button>
        </div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
          <button class="filter-btn" data-filter="unchecked">æœªç›¤é»</button>
          <button class="filter-btn" data-filter="checked">å·²ç›¤é»</button>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“¦</div>
          <div class="stat-info">
            <div class="stat-number" id="total-count">0</div>
            <div class="stat-label">ç¸½è¨­å‚™æ•¸</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-info">
            <div class="stat-number" id="checked-count">0</div>
            <div class="stat-label">å·²ç›¤é»</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â³</div>
          <div class="stat-info">
            <div class="stat-number" id="unchecked-count">0</div>
            <div class="stat-label">æœªç›¤é»</div>
          </div>
        </div>
      </div>
      
      <div class="table-container">
        <table id="equipment-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>ç·¨è™Ÿ</th>
              <th>åç¨±</th>
              <th>æ•™å®¤</th>
              <th>ç‹€æ…‹</th>
              <th>æœ€å¾Œæ›´æ–°</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="7" style="text-align: center; padding: 2rem; color: #6c757d;">
                è¼‰å…¥ä¸­...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- æª”æ¡ˆä¸Šå‚³å€åŸŸ -->
  <div class="upload-overlay" id="upload-overlay">
    <div class="upload-content">
      <div class="upload-icon">ğŸ“„</div>
      <h3>æ‹–æ”¾ CSV æª”æ¡ˆåˆ°æ­¤è™•</h3>
      <p>æˆ–è€…</p>
      <input type="file" id="file-input" accept=".csv" style="display: none;">
      <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">é¸æ“‡æª”æ¡ˆ</button>
      <button class="btn btn-secondary" onclick="closeUpload()">å–æ¶ˆ</button>
      <div class="file-format-help">
        <p><strong>CSV æ ¼å¼è¦æ±‚ï¼š</strong></p>
        <code>ç·¨è™Ÿ,åç¨±,æ•™å®¤<br>EQ001,æŠ•å½±æ©Ÿ,101æ•™å®¤<br>EQ002,é›»è…¦,102æ•™å®¤</code>
      </div>
    </div>
  </div>
  
  <!-- QR æƒæå™¨ -->
  <div class="qr-scanner" id="qr-scanner">
    <button class="close-scanner" onclick="closeQRScanner()">Ã—</button>
    <div class="qr-scanner-content">
      <h3>ğŸ“± QR Code æƒæå™¨</h3>
      <div class="camera-container">
        <video id="qr-video" playsinline></video>
        <div class="scan-overlay">
          <div class="scan-frame"></div>
        </div>
      </div>
      <p id="scan-status">æ­£åœ¨åˆå§‹åŒ–æƒæå™¨...</p>
      <div class="scanner-buttons">
        <button id="switch-camera" class="btn btn-secondary">ğŸ”„ åˆ‡æ›é¡é ­</button>
        <button onclick="closeQRScanner()" class="btn btn-primary">é—œé–‰æƒæå™¨</button>
      </div>
    </div>
  </div>

  <!-- è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ -->
  <div class="loading" id="loading" style="display: none;">
    <div class="spinner"></div>
    <p>è™•ç†ä¸­...</p>
  </div>

  <!-- Toast é€šçŸ¥å®¹å™¨ -->
  <div id="toast-container"></div>

  <!-- å¼•å…¥å¿…è¦çš„ JavaScript åº« -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <!-- å¼•å…¥è‡ªå®šç¾© JavaScript -->
  <script src="js/qr-scanner.js"></script>
  <script src="js/main.js"></script>
  
  <!-- æª”æ¡ˆä¸Šå‚³è™•ç† -->
  <script>
    // æª”æ¡ˆä¸Šå‚³åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('file-input');
      const uploadOverlay = document.getElementById('upload-overlay');
      
      if (fileInput) {
        fileInput.addEventListener('change', handleFileUpload);
      }
      
      // æ‹–æ”¾åŠŸèƒ½
      document.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadOverlay.classList.add('show');
      });
      
      document.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadOverlay.classList.remove('show');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].name.endsWith('.csv')) {
          handleFileUpload({ target: { files: files } });
        }
      });
      
      uploadOverlay.addEventListener('dragleave', (e) => {
        if (e.target === uploadOverlay) {
          uploadOverlay.classList.remove('show');
        }
      });
    });
    
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!file.name.endsWith('.csv')) {
        alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const csvText = e.target.result;
          
          // è§£æ CSV
          const result = Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            encoding: 'UTF-8'
          });
          
          if (result.errors.length > 0) {
            console.error('CSV è§£æéŒ¯èª¤:', result.errors);
          }
          
          // æ›´æ–°è³‡æ–™
          if (window.inventory && result.data.length > 0) {
            const newData = result.data.map(item => ({
              ç·¨è™Ÿ: item.ç·¨è™Ÿ || '',
              åç¨±: item.åç¨± || '',
              æ•™å®¤: item.æ•™å®¤ || '',
              ç‹€æ…‹: 'æœªç›¤é»',
              æœ€å¾Œæ›´æ–°: ''
            })).filter(item => item.ç·¨è™Ÿ && item.åç¨±);
            
            window.inventory.data = newData;
            window.inventory.generateClassrooms();
            window.inventory.restoreStatus(); // æ¢å¾©ä¹‹å‰çš„ç‹€æ…‹
            window.inventory.render();
            
            window.inventory.showToast(`æˆåŠŸè¼‰å…¥ ${newData.length} ç­†è¨­å‚™è³‡æ–™`, 'success');
          }
          
          closeUpload();
          
        } catch (error) {
          console.error('æª”æ¡ˆè™•ç†å¤±æ•—:', error);
          alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ CSV æ ¼å¼');
        }
      };
      
      reader.readAsText(file, 'UTF-8');
    }
    
    function closeUpload() {
      const overlay = document.getElementById('upload-overlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
      
      // æ¸…é™¤æª”æ¡ˆè¼¸å…¥
      const fileInput = document.getElementById('file-input');
      if (fileInput) {
        fileInput.value = '';
      }
    }
  </script>
</body>
</html>
